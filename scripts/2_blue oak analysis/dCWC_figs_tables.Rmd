---
title: "Untitled"
author: "Indra Boving"
date: "2024-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(tidyverse)
source(here::here("scripts", "scripts_functions", "figure_info.R"))
select = dplyr::select
datver <- "20230724"
```

```{r}
#OLD TABLE:
# sig_mods_all <- bind_rows(read_csv(here("processed-data", "model results", "dcwc_mods_lwa.csv")),
#                           read_csv(here("processed-data", "model results", "dcwc_mods_lwc.csv")),
#                           read_csv(here("processed-data", "model results", "dcwc_mods.csv"))
#                           ) %>%
#   mutate(across(where(is.numeric), ~ round(., 3)))
# sig_mods_all
# 
# 
# write_csv(sig_mods_all, here(here("processed-data", "model results", "table_sx.csv")))
```



#Load data: 

Need dCWC, MPa, LWmass, LWarea, LMA

```{r}
#from dCWC calculated with MPa analysis
dcwc_wholedaterange <- read_csv(here("processed-data", "dcwc_wholedaterange_df_no_outliers.csv")) %>% 
  select(-water_potential)

dcwc_beforeleafout <- read_csv(here("processed-data", "dcwc_beforeleafout_df_no_outliers.csv")) %>% 
  select(-water_potential)

dcwc_afterleafout <- read_csv(here("processed-data", "dcwc_afterleafout_df_no_outliers.csv")) %>% 
  select(-water_potential)

dcwc_justmay <- read_csv(here("processed-data", "dcwc_justmay_df_no_outliers.csv")) %>% 
  select(-water_potential)

#lma, mpa, and lwmass and lwarea data: 
data_qudo_lma <- read_csv(here("processed-data", paste0("wp_wc_rwc_",datver,".csv"))) %>% 
 # filter(time %in% c("md")) %>% 
  group_by(tree, week) %>% 
  mutate(lma_g_cm2 = mean(lma_g_cm2, na.rm = T), 
         water_potential = -1*water_potential) %>% 
  filter(species %in% c("blue oak")) %>% 
  select(week, tree, time, species, lma_g_cm2, water_potential, lwc_mean, lwa_g_cm2) %>% 
  distinct()


dcwc_alldata <- merge(dcwc_wholedaterange, data_qudo_lma, by = c("tree", "week", "time"), all = T) %>% 
  distinct()

dcwc_beforeleafout<- merge(dcwc_beforeleafout , data_qudo_lma, by = c("tree", "week", "time"), all = T) %>% 
  distinct()

dcwc_afterleafout<- merge(dcwc_afterleafout , data_qudo_lma, by = c("tree", "week", "time"), all = T) %>% 
  distinct()

dcwc_justmay <-  merge(dcwc_justmay, data_qudo_lma, by = c("tree", "week", "time"), all = T) %>% 
  distinct()
```

```{r}
#Many colors: 

nb.cols <- 25
pal <- met.brewer("Cross")
mycolors <- colorRampPalette(pal)(nb.cols)

color_very_many <- scale_color_manual(values = mycolors) 
```

#1. FIGURE: CWC over time, all dates: 

```{r}
dcwc_plot <- dcwc_alldata %>% 
  #filter(week %in% c(29:40)) %>% 
  distinct() %>% 
  drop_na(cwc) %>% 
  group_by(tree) %>% 
  mutate(COUNT = n()) %>% 
  filter(!(COUNT == 1)) %>% 
  select(-COUNT)  %>%
  group_by(tree) %>%
#filter out trees that werent measured in Sept. 
  filter(
    sum(format(date_wp, "%m") == "05") > 0,  # At least one measurement in May
    sum(format(date_wp, "%m") == "09") > 0,  # At least one measurement in September
    n() >= 2  # At least two measurements
  ) %>%
  ungroup()%>% 
  filter(time == "md", 
         species == "blue oak") %>%
  select(cwc, date_wp, tree) %>% 
  distinct() %>% 
  ggplot(aes( y = cwc, 
              x = date_wp, 
              color = as.factor(tree))) + 
  geom_point() +
  theme(legend.position="none",
       # legend.position= c(.7, .2),
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
     # axis.title = element_text(size = 16),
     axis.text.y = element_text(size = 12),
     axis.text.x = element_text(size = 12),
    # axis.text.x  = element_blank(),
     legend.key=element_blank(), 
     # axis.title.x = element_blank(),
    # axis.title.y = element_blank(),
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8),
    plot.margin = unit(c(5.5, 5.5, 0, 5.5), units = "pt")
    ) +
  geom_smooth(method = "lm", se = F,size = .5) +
  color_very_many +
  labs(y = "CWC (g/cm2)", 
       x = "Date")

dcwc_plot 
```
#2. TABLE: Test for significance

```{r}
library(dplyr)
library(tidyr)
library(purrr)

# Define the datasets and variables of interest
data_list <- list(
  dcwc_alldata = dcwc_alldata,
  dcwc_beforeleafout = dcwc_beforeleafout,
  dcwc_afterleafout = dcwc_afterleafout,
  dcwc_justmay = dcwc_justmay
)

variables <- c("water_potential", "lwa_g_cm2", "lwc_mean", "lma_g_cm2")

# Initialize an empty data frame to store results for each analysis and variable
sig_mods_all <- data.frame()

# Loop through each dataset and variable
for (analysis_name in names(data_list)) {
  analysis_data <- data_list[[analysis_name]]
  
  for (variable in variables) {
    
    # Set grouping based on the variable
    if (variable == "lma_g_cm2") {
      grouping_vars <- c("date_wp")
    } else {
      grouping_vars <- c("date_wp", "time")
    }
    
    # Run the model on each group and store results
    results <- analysis_data %>%
      group_by(across(all_of(grouping_vars))) %>%
      filter(n() > 1) %>%  # Ensure enough data points to fit a model
      nest() %>%          # Nest the data for each group
      mutate(model = map(data, ~ tryCatch(lm(slope ~ get(variable), data = .x), error = function(e) NULL))) %>%
      mutate(
        R_squared = map_dbl(model, ~ if (!is.null(.x)) summary(.x)$r.squared else NA),
        p_value = map_dbl(model, ~ {
          if (!is.null(.x) && nrow(summary(.x)$coefficients) >= 2) {
            summary(.x)$coefficients[2, 4]  # Extract p-value
          } else {
            NA  # Return NA if not enough coefficients
          }
        }),
        analysis = analysis_name,
        variable = variable
      ) %>%
      select(analysis, variable, everything(), -data, -model) %>%
      ungroup()
    
    # Add results to sig_mods_all
    sig_mods_all <- bind_rows(sig_mods_all, results)
  }
}

# Finalize sig_mods_all as a single data frame
sig_mods_all <- as.data.frame(sig_mods_all) %>% 
  clean_names() %>% 
  filter(p_value < 0.05) 

sig_mods_all

write_csv(sig_mods_all %>%
   mutate(across(where(is.numeric), ~ round(., 3))), here(here("processed-data", "model results", "table_sx.csv")))
```



#2. FIGURE: dCWC and the best dates: 
```{r}
fig_data <- merge(dcwc_alldata, sig_mods_all, by = c("date_wp", "time"), all.y = T) %>%
  mutate(column_name = round(r_squared, 3)) %>% 
  filter(!(variable == "lma_g_cm2"))

fig_data %>% 
  group_by(variable, date_wp, time) %>% 
  count()

dcwc_alldata %>% 
  group_by(week, date_wp, time) %>% 
  count()
```

- Best dates:
```{r}
mpa_plot <- fig_data %>% 
  filter(variable == "water_potential"
        ) %>% 
  select(slope, water_potential, time, date_wp, analysis, r_squared) %>% 
  ggplot(aes( y = water_potential, 
              x = slope, 
              shape = time,
              color = as.factor(r_squared))) + 
  geom_point() +
  theme(#legend.position="none",
       # legend.position= c(.7, .2),
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
     # axis.title = element_text(size = 16),
     axis.text.y = element_text(size = 12),
     axis.text.x = element_text(size = 12),
    # axis.text.x  = element_blank(),
     legend.key=element_blank(), 
     # axis.title.x = element_blank(),
    # axis.title.y = element_blank(),
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8),
    plot.margin = unit(c(5.5, 5.5, 0, 5.5), units = "pt")
    ) +
  facet_wrap(~~analysis*date_wp, scales = "free") +
  geom_smooth(method = "lm", se = F,size = .5) +
  labs(y = "Water potential (Psi)", 
       x = "Slope")
mpa_plot
```

```{r}
lwc_plot <- fig_data %>% 
  filter(variable == "lwc_mean"
        ) %>% 
  select(slope, lwc_mean, time, date_wp, analysis, r_squared) %>% 
  ggplot(aes( y = lwc_mean, 
              x = slope, 
              shape = as.factor(analysis),
              color = as.factor(r_squared))) + 
  geom_point() +
  theme(#legend.position="none",
       # legend.position= c(.7, .2),
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
     # axis.title = element_text(size = 16),
     axis.text.y = element_text(size = 12),
     axis.text.x = element_text(size = 12),
    # axis.text.x  = element_blank(),
     legend.key=element_blank(), 
     # axis.title.x = element_blank(),
    # axis.title.y = element_blank(),
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8),
    plot.margin = unit(c(5.5, 5.5, 0, 5.5), units = "pt")
    ) +
  facet_wrap(~~analysis*date_wp, scales = "free") +
  geom_smooth(method = "lm", se = F,size = .5) +
  labs(y = "LWmass (g)", 
       x = "Slope")
lwc_plot
```

```{r}
lwa_plot <- fig_data %>% 
  filter(variable == "lwa_g_cm2"
        ) %>% 
  select(slope, lwa_g_cm2, time, date_wp, analysis, r_squared) %>% 
  ggplot(aes( y = lwa_g_cm2, 
              x = slope, 
              shape = as.factor(analysis),
              color = as.factor(r_squared))) + 
  geom_point() +
  theme(#legend.position="none",
       # legend.position= c(.7, .2),
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
     # axis.title = element_text(size = 16),
     axis.text.y = element_text(size = 12),
     axis.text.x = element_text(size = 12),
    # axis.text.x  = element_blank(),
     legend.key=element_blank(), 
     # axis.title.x = element_blank(),
    # axis.title.y = element_blank(),
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8),
    plot.margin = unit(c(5.5, 5.5, 0, 5.5), units = "pt")
    ) +
  facet_wrap(~analysis*date_wp, scales = "free") +
  geom_smooth(method = "lm", se = F,size = .5) +
  labs(y = "LWarea (g/cm2)", 
       x = "Slope")
lwa_plot
```


```{r}
lma_fig_data <- merge(dcwc_alldata, sig_mods_all, by = c("date_wp"), all = T)
  
lma_plot <- lma_fig_data %>% 
  filter(variable == "lma_g_cm2"
        ) %>% 
  select(slope, lma_g_cm2, date_wp, analysis, r_squared) %>% 
  ggplot(aes( y = lma_g_cm2, 
              x = slope, 
              shape = as.factor(analysis),
              color = as.factor(r_squared))) + 
  geom_point() +
  theme(#legend.position="none",
       # legend.position= c(.7, .2),
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
     # axis.title = element_text(size = 16),
     axis.text.y = element_text(size = 12),
     axis.text.x = element_text(size = 12),
    # axis.text.x  = element_blank(),
     legend.key=element_blank(), 
     # axis.title.x = element_blank(),
    # axis.title.y = element_blank(),
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8),
    plot.margin = unit(c(5.5, 5.5, 0, 5.5), units = "pt")
    ) +
  facet_wrap(~analysis*date_wp, scales = "free") +
  geom_smooth(method = "lm", se = F,size = .5) +
  labs(y = "LMA (g/cm2)", 
       x = "Slope")
lma_plot
```


