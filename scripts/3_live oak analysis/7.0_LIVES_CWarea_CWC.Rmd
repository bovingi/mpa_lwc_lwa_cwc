---
title: "Establishing relationships between cw_area and LWA"
author: "Indra Boving"
date: "11/9022"
output:
  html_document: default
  word_document: default
---

#Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(tidyverse)
library(boot)
source(here::here("scripts", "scripts_functions", "figure_info.R"))

library(data.table)
library(janitor)
library(here)
library(tidyverse)
library(lubridate)
library(readxl)
library(gridExtra)
#library(calecopal)
library(rstatix)
library(vars)
library(MuMIn)
library(lme4) #for mixed effects models
library(arm)
library(nlme)
select = dplyr::select

library(cowplot)
library(grid)
library(gridExtra)

#source(here::here("scripts", "scripts_functions", "figure_info.R"))

datver <- "20230724" #make sure this matches the datver in the processing script
dataversion <- paste0("Data_", datver)
```

# DATA:

```{r}
data_og_cwc <- read_csv(here("processed-data", paste0("cwc_analysis",datver,".csv")), show_col_types = F) %>%  
  filter(species %in% c("live oak")) %>% 
  select(tree, week, water_potential, cwc, time_season, time, site, date_wp, date_shift) %>% 
  distinct() %>% 
   # filter(!tree %in% c(2012, 2011)) %>% 
  filter(!(tree %in% c(2346))) %>% #this tree seems to have a problem with post-leafout cw_area - all 0s - likely becuase the canopy was too small to see. 
  filter(!week %in% c(11, 9, 18)) #week 11 only has 9 midday measurements and acts really odd (2022-03-15), 9 just had 3 measurements 

##LMA, LWA, LWC data: 
data_quag_lma <- read_csv(here("data", paste0("wp_wc_rwc_",datver,".csv"))) %>% 
 # filter(time %in% c("md")) %>% 
  group_by(tree, week) %>% 
  mutate(lwa_g_cm2 = lwa_g_cm2_new, #use the 'new' version, increases sample size because this includes estimates from bulk data.
         lma_g_cm2 = mean(lma_g_cm2_new, na.rm = T)) %>% 
  filter(species %in% c("live oak")) %>% 
  select(week, time, tree, species, lma_g_cm2, lwa_g_cm2, lwc_mean) %>% 
  distinct()

data_quag_lma <- read_csv(here("processed-data", paste0("analysis_bothspp",datver,".csv")))  %>% 
  filter(species %in% c("live oak")) %>% 
  select(week, time, tree, species, lma_g_cm2, lwa_g_cm2, lwc_mean) %>% 
  distinct()


df0 <- merge(data_quag_lma, data_og_cwc,
            , by = c("tree", "week", "time"), all = T) %>% 
  mutate(season = case_when(
    week %in% c(1:29) ~ "spring/early summer",
    week %in% c(30:45) ~ "late summer/fall"
  )) 

##LAI data: 

data_quag_lai_spring <-  read_csv(here("data", "LAI_final.csv")) %>% 
  clean_names() %>% 
  select(treestr, springlai) %>% 
  mutate(tree = as.numeric(treestr))

lai_raw <-  read_csv(here("data", "LAI_final.csv")) %>% 
  clean_names() %>% 
  select(-difflai, -species, -springstdev)

data_quag_lai_df <-  lai_raw %>% 
  pivot_longer(names_to = "time",
               values_to = "lai",
               cols = c(2:5)) %>% 
  mutate(tree = as.numeric(treestr)) %>% 
  mutate(season = case_when(
    time %in% c("springlai") ~ "spring/early summer",
    time %in% c("septlai") ~ "late summer/fall"
  )) %>% 
  drop_na(season) %>% 
  select(-time)
         
df <- merge(df0, data_quag_lai_df, 
            by = c("tree", "season"),
            all.x = T) %>% 
  group_by(tree, time, week) %>% 
  fill(c(lwa_g_cm2), .direction = "downup") %>% 
  mutate(cw_area = lma_g_cm2*lwc_mean*lai) %>% 
  filter(cwc > 0)

df_nodates <- df %>% 
  filter(is.na(date_wp))
```

#--------------

#Bootstrapping

##TIME:

####(To get filtered_data)
```{r}
data_all <- df %>% 
  filter(time == "md") 

# Filter for trees measured "before leafout"
before_leafout_data <- data_all %>%
  filter(time_season == "before leafout")

# Filter for trees measured "after leafout"
after_leafout_data <- data_all %>%
  filter(time_season == "after leafout")

# Find the common set of trees that appear in both datasets
common_trees <- intersect(before_leafout_data$tree, after_leafout_data$tree)

# Filter the original dataset to include only the common trees
common_trees_data <- data_all %>%
  filter(tree %in% common_trees)

# Assuming you have the 'common_trees_data' dataframe

# Get the unique tree IDs in 'common_trees_data'
unique_tree_ids <- unique(common_trees_data$tree)

# Count the number of unique tree IDs
num_unique_tree_ids <- length(unique_tree_ids)

# Print the number of unique tree IDs
cat("Number of unique tree IDs in common_trees_data:", num_unique_tree_ids, "\n")

# Filter the original dataset to include only the common tree IDs
filtered_data <- data_all[data_all$tree %in% common_trees, ]
```


```{r}
plotly::ggplotly(filtered_data %>% 
  drop_na(week)  %>% 
  group_by(tree) %>% 
  mutate(COUNT = n()) %>% 
  filter(!(COUNT == 1)) %>% 
  select(-COUNT) %>% 
  ggplot(aes(y = cwc, 
             x = cw_area, 
             color = time_season, 
             size = week,
             shape = as.factor(tree),
             show.legend = FALSE, 
             label = tree)) +
  geom_point(size = 1,
             alpha = .3)+
  geom_smooth(method = "lm", se = F) +
 # theme(legend.position = "none") +
  labs(x = "cw_area", 
       y = "LWA") +
  #color_two_grey +
  theme(
      legend.position="none",
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
      axis.title = element_text(size = 16),
     axis.text = element_text(size = 12),
     legend.key=element_blank(), 
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8)
    ) +
  geom_smooth(method = "lm", se = F) + 
 # geom_vline(xintercept = 0, linetype = "dotted") +
  labs(y= "LWA", 
       x = "CWarea (g/cm2)", 
       color = "Week", 
       ) +
  guides(color = guide_legend(nrow = 2)) +
  facet_wrap(~time, nrow = 2) +
  color_two_grey)
```


```{r}
###Before leafout: 

data <- filtered_data  %>% 
  filter(time_season == "before leafout") %>% 
  distinct() %>% 
  drop_na(cwc, cw_area) %>% 
  group_by(tree) %>% 
  mutate(COUNT = n()) %>% 
  filter(!(COUNT == 1)) %>% 
  select(-COUNT)
data

num_unique_trees <- length(unique(data$tree))
cat("Number of unique trees in the dataset:", num_unique_trees, "\n")

# Assuming your dataset is called 'data'
# Make sure 'data' is properly loaded before proceeding

# Define the number of bootstrap iterations
n_iterations <- 1000

# Number of random trees to sample
n_sample_trees <- num_unique_trees  # Adjust as needed based on the number of unique trees
n_sample_trees

# Create an empty data frame to store bootstrapped slopes
bootstrapped_slopes_df <- data.frame()

# Function to calculate the slope for a specific tree within each iteration
calculate_slope_for_tree <- function(tree_data) {
  model <- lm(cwc ~ cw_area, data = tree_data)
  return(coef(model)[2])  # Extract the slope coefficient
}

#Do the bootstrapping: 

 for (i in 1:n_iterations) {
   
# Randomly sample 'n_sample_trees' trees from your dataset
sampled_tree_ids <- sample(unique(data$tree), size = n_sample_trees, replace = TRUE)

# Iterate through each sampled tree and perform bootstrapping separately
      for (tree_id in sampled_tree_ids) {
        
        tree_data <- data %>%
          filter(tree == tree_id)
        
        # Initialize a container to store slopes for each iteration
        slopes <- vector("double", length = 1)
      
          # Calculate the slope for the bootstrapped sample
          slopes[] <- calculate_slope_for_tree(tree_data)
        
        # Store the bootstrapped slopes for this tree in the data frame
        bootstrapped_slopes_df <- bind_rows(
          bootstrapped_slopes_df,
          data.frame(
            tree = tree_id,
            slope = slopes, 
            round = i
          ) 
        ) 
      }
 }

        ci_values <- bootstrapped_slopes_df %>%
        group_by(round) %>% 
        drop_na(slope) %>%
       mutate(
          mean_slope_round = mean(slope, na.rm = T)
        ) %>% 
          ungroup() %>% 
          mutate(mean = mean(mean_slope_round, na.rm = T),
          lower_bound = quantile(mean_slope_round, 0.025, na.rm = TRUE),
          upper_bound = quantile(mean_slope_round, 0.975, na.rm = TRUE))
          
        
        # Merge the CI values back into the original dataframe
      tbootstrapped_slopes_df_before <- ci_values 
      
# Print the updated dataframe with CI values
print(tbootstrapped_slopes_df_before)

summary(tbootstrapped_slopes_df_before)

mean_slope_before = tbootstrapped_slopes_df_before %>% 
  mutate(mean_slope = mean(mean, na.rm = T),
         pre_post = "before leafout") %>% 
  select(mean_slope, lower_bound, upper_bound, pre_post) %>% 
  distinct()
mean_slope_before
```


```{r}
###After leafout: 

data <- common_trees_data %>% 
  filter(time_season == "after leafout") %>% 
  select(tree, week, cwc, cw_area) %>% 
  distinct() %>% 
  drop_na(cwc, cw_area) %>% 
  group_by(tree) %>% 
  mutate(COUNT = n()) %>% 
  filter(!(COUNT == 1)) %>% 
  select(-COUNT) 

num_unique_trees <- length(unique(data$tree))
cat("Number of unique trees in the dataset:", num_unique_trees, "\n")

# Assuming your dataset is called 'data'
# Make sure 'data' is properly loaded before proceeding

# Define the number of bootstrap iterations
n_iterations <- 1000

# Number of random trees to sample
n_sample_trees <- num_unique_trees # Adjust as needed

# Create an empty data frame to store bootstrapped slopes
bootstrapped_slopes_df <- data.frame()

# Function to calculate the slope for a specific tree within each iteration
calculate_slope_for_tree <- function(tree_data) {
  model <- lm(cwc ~ cw_area, data = tree_data)
  return(coef(model)[2])  # Extract the slope coefficient
}

#Do the bootstrapping: 

 for (i in 1:n_iterations) {
   
# Randomly sample 'n_sample_trees' trees from your dataset
sampled_tree_ids <- sample(unique(data$tree), size = n_sample_trees, replace = TRUE)

# Iterate through each sampled tree and perform bootstrapping separately
      for (tree_id in sampled_tree_ids) {
        
        tree_data <- data %>%
          filter(tree == tree_id)
        
        # Initialize a container to store slopes for each iteration
        slopes <- vector("double", length = 1)
      
          # Calculate the slope for the bootstrapped sample
          slopes[] <- calculate_slope_for_tree(tree_data)
        
        # Store the bootstrapped slopes for this tree in the data frame
        bootstrapped_slopes_df <- bind_rows(
          bootstrapped_slopes_df,
          data.frame(
            tree = tree_id,
            slope = slopes, 
            round = i
          ) 
        ) 
      }
 }

        ci_values <- bootstrapped_slopes_df %>%
        group_by(round) %>% 
        drop_na(slope) %>%
       mutate(
          mean_slope_round = mean(slope, na.rm = T)
        ) %>% 
          ungroup() %>% 
          mutate(mean = mean(mean_slope_round, na.rm = T),
          lower_bound = quantile(mean_slope_round, 0.025, na.rm = TRUE),
          upper_bound = quantile(mean_slope_round, 0.975, na.rm = TRUE))
          
        
        # Merge the CI values back into the original dataframe
      tbootstrapped_slopes_df_after <- ci_values 
      
# Print the updated dataframe with CI values
print(tbootstrapped_slopes_df_after)

summary(tbootstrapped_slopes_df_after)

mean_slope_after = tbootstrapped_slopes_df_after %>% 
  mutate(mean_slope = mean(mean, na.rm = T),
         pre_post = "after leafout") %>% 
  select(mean_slope, lower_bound, upper_bound, pre_post) %>% 
  distinct()
mean_slope_after

#Combining before and after: 


cw_area_time_boot_df <- bind_rows(mean_slope_before, mean_slope_after) %>% 
  select(pre_post, mean_slope, lower_bound, upper_bound) %>% 
  distinct() %>% 
  mutate(analysis = "time, ind. tree")

cw_area_time_boot_df %>% 
  group_by(pre_post) %>% 
  mutate(tree_mean = mean(mean_slope, na.rm = T)) %>% 
  ggplot() +
  geom_point(aes(y = tree_mean, 
             x = pre_post)) +
  geom_point(aes(y = upper_bound, 
                 x= pre_post), color = "blue")  +
  geom_point(aes(y = lower_bound, 
                 x= pre_post), color = "pink")  +
  theme_minimal()
```

#SPACE: 
####***Slopes, MD, NOT Centered

Get slopes from random effects: 

NOTE: this includes site random effect, which the centered version does not need. 

```{r}
space_nice <- df %>% 
  filter(time == "md") %>% 
  drop_na(site) %>% 
  ggplot(aes(y = cwc, 
            # x = cw_area_centered, 
            x = cw_area,
             #color = tree_factor
             color = as.factor(week)
             )) +
  geom_point(alpha = 1, 
            # aes (shape = site)
             ) +
  theme(legend.position="none",
       # legend.position= c(.7, .2),
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
     # axis.title = element_text(size = 16),
     axis.text = element_text(size = 12),
     legend.key=element_blank(), 
      axis.title.x = element_blank(),
     axis.title.y = element_text(size = 20), 
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8)
    ) +
  geom_smooth(method = "lm", se = F) + 
 # geom_vline(xintercept = 0, linetype = "dotted") +
  labs(y= "Middays (MPa)", 
       x = "CW_area", 
       color = "Week", 
       shape = "Site") +
  color_many_2 +
  #color_week_all +
  guides(color = guide_legend(nrow = 2))
space_nice
```


```{r}
data <- df %>% 
  filter(time == "md") %>% 
  select(tree, week, cwc, cw_area, site) %>% 
  distinct() %>% 
  drop_na(cw_area, cwc)

#HOW MANY trees? 

data %>% 
  drop_na(cwc, cw_area) %>% 
  group_by(week, site) %>% 
  count()
#..not a lot with site, so probably wont need site

#model without site: 
space_mod_4 <- lmer(cwc ~ cw_area + (cw_area|week), data =  data , REML = T)

space_mod_df_4 <- broom.mixed::tidy(space_mod_4)
#space_mod_df

ran_list3 <- coef(space_mod_4)

#ran_list2 <- coef(m_wk_rand)

ran_df_4 <- as.data.frame(ran_list3[['week']])%>% 
  mutate(estimate = `(Intercept)`, 
         slope = `cw_area`, 
         -cw_area) %>%
  select(-`(Intercept)`)

ran_err_4 <- arm::se.ranef(space_mod_4)

ran_err_df_4 <- as.data.frame(ran_err_4[['week']]) %>% 
  mutate(std.error = `(Intercept)`, 
         std.error.slope = `cw_area`)%>% 
  select(-`(Intercept)`, 
         -cw_area) %>% 
  tibble::rownames_to_column("week")

ran_df_week_4 <- bind_cols(ran_df_4, ran_err_df_4) %>% 
  #select(-`1:10`) %>% 
  data_frame()

final_df_space_se <- ran_df_week_4 

space_slope <- final_df_space_se %>% 
  mutate(week = as.factor(week)) %>% 
 # filter(week %in% c(14, 17, 21, 29)) %>% 
 # filter(term == "cwc") %>% 
  mutate(upr = slope + 1.96*(std.error.slope), 
         lwr = slope - 1.96*(std.error.slope)) %>% 
  ggplot(aes(color= week)
    ) + 
  geom_point(aes(y = slope ,x = week), size =2) +
    geom_point(aes(y = upr, x = week), size = 1) +
  geom_point(aes(y = lwr, x = week), size = 1) +
  #geom_line(aes(group = week, y = week, x = upr)) +
  geom_segment(aes(y= lwr, 
                   yend = upr, 
                   x = week, 
                   xend = week, 
                   color = week))+
  labs(x = "Week", 
       color = "Week", 
       y = "Slope - space") +
  theme(legend.position="none",
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_blank(),
     axis.text = element_text(size = 12),
     legend.key=element_blank(), 
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8)
    ) +
  geom_hline(yintercept = 0, linetype="dotted") + 
    color_many_2 +
  guides(color = guide_legend(nrow = 2))
space_slope
```


```{r}
# Define the number of bootstrap iterations
n_iterations <- 1000

# Create an empty dataframe to store results
cw_area_final_df_space <- data.frame(week = integer(), 
                                     mean_slope = numeric(), 
                                     lower_bound = numeric(), 
                                     upper_bound = numeric())

# Get unique weeks in your dataset
unique_weeks <- unique(data$week)

# Iterate through each week
for (x in unique_weeks) {
  # Step 1: Filter data for the current week
  week_data <- data %>%
    filter(week == x)
  
  # Step 2: Initialize a container to store bootstrapped slopes
  slopes <- vector("double", length = n_iterations)
  
  # Step 3: Perform bootstrapping to estimate slopes
  for (i in 1:n_iterations) {
    # Randomly sample rows with replacement
    boot_indices <- sample(nrow(week_data), replace = TRUE)
    boot_sample <- week_data[boot_indices, ]
    
    # Calculate the slope for the bootstrapped sample
    model <- lm(cwc ~ cw_area, data = boot_sample)
    slopes[i] <- coef(model)[2]
  }
  
  # Step 4: Calculate the mean slope and 95% CI
  mean_slope <- mean(slopes, na.rm = TRUE)
  lower_bound <- quantile(slopes, 0.025, na.rm = TRUE)
  upper_bound <- quantile(slopes, 0.975, na.rm = TRUE)
  
  # Step 5: Store the results in the final dataframe
  cw_area_final_df_space <- bind_rows(cw_area_final_df_space, 
                                  data.frame(week = x, 
                                             mean_slope = mean_slope,
                                             lower_bound = lower_bound, 
                                             upper_bound = upper_bound))
}

# Print the final dataframe
print(cw_area_final_df_space)

cw_area_final_df_space %>% 
  ggplot(aes(x = week)) +
   geom_segment(aes(y= lower_bound, 
                   yend = upper_bound, 
                   x = week, 
                   xend = week, 
                   color = as.factor(week)))+
  geom_point(aes(y = mean_slope), color = "cyan") +
  geom_point(aes(y = lower_bound), color = "pink") +
  geom_point(aes(y = upper_bound), color = "gold") +
  geom_hline(yintercept =0) +
  labs(y = "Slope",
       x = "Week")
  
```

#COMBINE

Should be week, mean_slope, lower_bound, upper_bound

```{r}
cw_area_final_df_space <- cw_area_final_df_space %>% 
  mutate(analysis = "space", 
         time_season = "NA")

cw_area_time_boot_df <- cw_area_time_boot_df %>% 
  mutate(week = 0,
         time_season = pre_post)

final_df_all_cw_area <- bind_rows(cw_area_final_df_space, cw_area_time_boot_df) %>% 
  mutate(slope = mean_slope, 
         lwr = lower_bound, 
         upr = upper_bound) 

final_df_all_cw_area %>% write_csv(here::here("processed-data", "bootstrapped_df_quag_cwc_cw_area.csv"))
```
#------------

#START HERE to skip bootstrapping: 
```{r}
final_df_all_cw_area <- read_csv(here::here("processed-data", "bootstrapped_df_quag_cwc_cw_area.csv"))
```

#------------

#Analysis: 

#Data wrangling: 

```{r, echo=F}
wc_quag_df <-  df %>% 
  drop_na(time)

wc_lm_df <- wc_quag_df %>% 
  filter(week > 17)

wk_all <- wc_quag_df 

wk_all_wide <- wk_all %>% 
  #drop_na(date_wp) %>% 
  pivot_wider(names_from=time, 
              values_from = c(cw_area, cwc), 
              values_fn = function(x) mean(x, na.rm = TRUE)
              ) %>% 
    dplyr::group_by(tree, week) %>%
  fill(c(cw_area_md, cw_area_pd, cwc_pd, cwc_md), .direction = "downup") %>%
  dplyr::ungroup()%>% 
 # select(-date_wp) %>% 
  distinct()

wk_all_long_cw_area <- wk_all_wide %>% 
  drop_na(cw_area_pd, cw_area_md, cwc_md, cwc_pd) %>% 
  select(-cwc_md, -cwc_pd) %>% 
  mutate(pd = cw_area_pd, 
         md = cw_area_md) %>% 
  pivot_longer(cols = c(pd, md), 
               names_to = "time", 
               values_to = "cw_area") %>% 
  select(-cw_area_pd, -cw_area_md)

wk_all_long_mpa <- wk_all_wide %>% 
  drop_na(cw_area_pd, cw_area_md, cwc_md, cwc_pd) %>% 
  select(-cw_area_md, -cw_area_pd) %>% 
  mutate(pd = cwc_pd, 
         md = cwc_md) %>% 
  distinct() %>% 
  pivot_longer(cols = c(pd, md), 
               names_to = "time", 
               values_to = "cwc") %>% 
  select(-cwc_pd, -cwc_md)

wk_all_long <- merge(wk_all_long_mpa, wk_all_long_cw_area) %>% 
  distinct() %>% 
 # select(-cw_area_NA, -cwc_NA) %>% 
  group_by(tree, week, time) %>% 
  summarise(cw_area = mean(cw_area, na.rm = T), 
            cwc = mean(cwc, na.rm = T), 
            site = site) %>% 
ungroup() %>% 
  group_by(tree) %>% 
  fill(site, .direction = "downup")
```


#SPACE:

1. Center and scale by week
2. Plot all midday grand slopes

###Midday: 

```{r, warning = F}
wc_wk_centered_df <- wk_all_long %>% 
  mutate(cwc = cwc) %>% 
  filter(time == "md") %>% 
  group_by(week) %>% 
  mutate(mean_cw_area = mean(cw_area, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(cw_area_centered = cw_area - mean_cw_area)
  # mutate(cw_area_centered = scale(cw_area,  scale=FALSE)) %>% 
  # filter(cw_area_centered < 4)
```


```{r, warning = F, echo=FALSE}
#scaled
space_nice <- wc_wk_centered_df %>% 
  drop_na(site) %>% 
  ggplot(aes(y = cwc, 
            # x = cw_area_centered, 
            x = cw_area,
             #color = tree_factor
             color = as.factor(week)
             )) +
  geom_point(alpha = .5, 
            # aes (shape = site)
             ) +
  theme(legend.position="none",
       # legend.position= c(.7, .2),
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
     # axis.title = element_text(size = 16),
     axis.text = element_text(size = 12),
     legend.key=element_blank(), 
      axis.title.x = element_blank(),
     axis.title.y = element_text(size = 20), 
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8)
    ) +
  geom_smooth(method = "lm", se = F) + 
 # geom_vline(xintercept = 0, linetype = "dotted") +
  labs(y= "Middays (MPa)", 
       x = "CWarea", 
       color = "Week", 
       shape = "Site") +
  color_many_2 +
  #color_week_all +
  guides(color = guide_legend(nrow = 2))
space_nice

ggsave(here("figures", "quag figures", "cw_area", "cw_area", "nice_space_cwc_cw_area"), space_nice, device = "jpg", width = 6, height = 4, dpi = 300)
```


Do we need to include site here? 

cw_area uncentered:

```{r}
space_df_nosite <- wc_wk_centered_df %>% 
  drop_na(site)

space_mod <- lmer(cwc ~ cw_area + (cw_area|week), data = space_df_nosite, REML = T)
#summary(space_mod)

space_mod_site <- lmer(cwc ~ cw_area  + (cw_area|week) + (1|site), data = space_df_nosite,  REML = T)
#summary(space_mod_site)

anova(space_mod, space_mod_site)
```
Yes, site

Visualize: 
```{r}
wc_wk_centered_df %>% 
  drop_na(site) %>% 
  ggplot(aes(y = cwc, 
            # x = cw_area_centered, 
            x = cw_area,
             #color = tree_factor
             color = as.factor(week),
            shape = site
             )) +
  geom_point(alpha = .5, 
            # aes (shape = site)
             ) +
  theme(legend.position="none",
       # legend.position= c(.7, .2),
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
     # axis.title = element_text(size = 16),
     axis.text = element_text(size = 12),
     legend.key=element_blank(), 
      axis.title.x = element_blank(),
     axis.title.y = element_text(size = 20), 
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8)
    ) +
  geom_smooth(method = "lm", se = F) + 
 # geom_vline(xintercept = 0, linetype = "dotted") +
  labs(y= "Middays (MPa)", 
       x = "CWarea", 
       color = "Week", 
       shape = "Site") +
  color_many_2 +
  #color_week_all +
  guides(color = guide_legend(nrow = 2))
```

##Slopes, MD, NOT Centered

Get slopes from random effects: 

```{r, echo=FALSE}
space_mod_4 <- lmer(cwc ~ cw_area + (cw_area|week) + (1|site), data =  wc_wk_centered_df, REML = T)

space_mod_df_4 <- broom.mixed::tidy(space_mod)
#space_mod_df

ran_list3 <- coef(space_mod_4)

#ran_list2 <- coef(m_wk_rand)

ran_df_4 <- as.data.frame(ran_list3[['week']])%>% 
  mutate(estimate = `(Intercept)`, 
         slope = `cw_area`, 
         -cw_area) %>%
  select(-`(Intercept)`)

ran_err_4 <- arm::se.ranef(space_mod_4)

ran_err_df_4 <- as.data.frame(ran_err_4[['week']]) %>% 
  mutate(std.error = `(Intercept)`, 
         std.error.slope = `cw_area`)%>% 
  select(-`(Intercept)`, 
         -cw_area) %>% 
  tibble::rownames_to_column("week")

ran_df_week_4 <- bind_cols(ran_df_4, ran_err_df_4) %>% 
  #select(-`1:10`) %>% 
  data_frame()

space_slope <- ran_df_week_4 %>% 
  mutate(week = as.factor(week)) %>% 
 # filter(week %in% c(14, 17, 21, 29)) %>% 
 # filter(term == "cw_area") %>% 
  mutate(upr = slope + (std.error.slope), 
         lwr = slope - (std.error.slope)) %>% 
  ggplot(aes(color= week)
    ) + 
  geom_point(aes(y = slope ,x = week), size =2) +
    geom_point(aes(y = upr, x = week), size = 1) +
  geom_point(aes(y = lwr, x = week), size = 1) +
  #geom_line(aes(group = week, y = week, x = upr)) +
  geom_segment(aes(y= lwr, 
                   yend = upr, 
                   x = week, 
                   xend = week, 
                   color = week))+
  labs(x = "Week", 
       color = "Week", 
       y = "Slope - space") +
  theme(legend.position="none",
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_blank(),
     axis.text = element_text(size = 12),
     legend.key=element_blank(), 
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8)
    ) +
  geom_hline(yintercept = 0, linetype="dotted") + 
    color_many_2 +
  guides(color = guide_legend(nrow = 2))
space_slope
```

#Which weeks are significant?

```{r}
mod <- lmer(cwc ~ cw_area*week + (1|site), data =wc_wk_centered_df %>% 
              mutate(week = as.factor(week)))

anova(mod)

library("lmerTest")
summary(mod)

library(emmeans)
emmeans(mod, list(pairwise ~ week), adjust = "tukey")
```

```{r}
unique(wc_wk_centered_df$week)

#week 10: 
wk <- wc_wk_centered_df %>% 
  drop_na(site) %>% 
  mutate(week = as.factor(week)) %>% 
  filter(week == 10)

space_mod <- lmer(cwc ~ cw_area + (1|site), data =  wk,  REML = T)
summary(space_mod)
#not sig

#week 12: 
wk <- wc_wk_centered_df %>% 
  drop_na(site) %>% 
  mutate(week = as.factor(week)) %>% 
  filter(week == 12)

space_mod <- lmer(cwc ~ cw_area + (1|site), data =  wk,  REML = T)
summary(space_mod)
#Sig

#week 14: 
wk <- wc_wk_centered_df %>% 
  drop_na(site) %>% 
  mutate(week = as.factor(week)) %>% 
  filter(week == 14)

space_mod <- lm(cwc ~ cw_area, data =  wk)
summary(space_mod)
#not sig

#week 15: 

#not sig

#week 17: 
wk <- wc_wk_centered_df %>% 
  drop_na(site) %>% 
  mutate(week = as.factor(week)) %>% 
  filter(week == 17)

space_mod <- lm(cwc ~ cw_area, data =  wk)
summary(space_mod)
#not sig

#week 19: 
wk <- wc_wk_centered_df %>% 
  drop_na(site) %>% 
  mutate(week = as.factor(week)) %>% 
  filter(week == 19)

space_mod <- lm(cwc ~ cw_area, data =  wk)
summary(space_mod)
#sig, p = 0.008

#week 21: 
wk <- wc_wk_centered_df %>% 
  drop_na(site) %>% 
  mutate(week = as.factor(week)) %>% 
  filter(week == 21)

space_mod <- lm(cwc ~ cw_area, data =  wk)
summary(space_mod)
#not sig



#week 37: 
wk <- wc_wk_centered_df %>% 
  drop_na(site) %>% 
  mutate(week = as.factor(week)) %>% 
  filter(week == 37)

space_mod <- lmer(cwc ~ cw_area  + (1|site), data =  wk,  REML = T)
summary(space_mod)
#not sig
```

###Slopes, from bootsrapping: 

```{r}
space_slopes <- final_df_all_cw_area %>% 
   filter(!week %in% c(9)) %>% 
  filter(analysis == "space") %>% 
   mutate(week = as.factor(week)) %>% 
  ggplot(aes(color= week)
    ) + 
  geom_point(aes(y = slope ,x = week), size =2) +
    geom_point(aes(y = upr, x = week), size = 1) +
  geom_point(aes(y = lwr, x = week), size = 1) +
  #geom_line(aes(group = week, y = week, x = upr)) +
  geom_segment(aes(y= lwr, 
                   yend = upr, 
                   x = week, 
                   xend = week, 
                   color = week))+
  labs(x = "Week", 
       color = "Week", 
       y = "Slope - space") +
  theme(legend.position="none",
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_blank(),
     axis.text = element_text(size = 12),
     legend.key=element_blank(), 
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8)
    ) +
  geom_hline(yintercept = 0, linetype="dotted") + 
    color_many_2 +
  guides(color = guide_legend(nrow = 2))
space_slopes
```

#TIME

```{r}
wc_quag_df %>% 
  drop_na(week) %>% 
  ggplot(aes(y = cw_area, 
             x = as.factor(week), 
             fill = time)) +
  geom_boxplot() +
 # facet_wrap(~time) +
  color_many +
  color_fill +
  labs(y = "cw_area", 
       x = "Week", 
       fill = "Time")
```

```{r, echo=FALSE, warning = F}
time <- wc_quag_df %>% 
  drop_na(week) %>% 
  ggplot(aes(y = cwc, 
             x = cw_area, 
             color = time_season, 
             size = week,
             shape = as.factor(tree),
             show.legend = FALSE)) +
  geom_point(size = 1,
             alpha = .3)+
  geom_smooth(method = "lm", se = F) +
 # theme(legend.position = "none") +
  labs(x = "cw_area", 
       y = "Midday MPa") +
  #color_two_grey +
  theme(
      legend.position="none",
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
      axis.title = element_text(size = 16),
     axis.text = element_text(size = 12),
     legend.key=element_blank(), 
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8)
    ) +
  geom_smooth(method = "lm", se = F) + 
 # geom_vline(xintercept = 0, linetype = "dotted") +
  labs(y= "Middays (MPa)", 
       x = "Leaf Water Content (g)", 
       color = "Week", 
       ) +
  guides(color = guide_legend(nrow = 2)) +
  facet_wrap(~time, nrow = 2) +
  color_two_grey
time 

ggsave(here("figures", "quag figures", "cw_area", "nice_time"), time, device = "jpg", width = 4, height = 2, dpi = 300)
```



```{r, echo=FALSE}
wc_quag_df %>% 
  filter(time == "pd") %>% 
  ggplot(aes(y = cwc, 
             x = cw_area, 
             color = as.factor(tree), 
             show.legend = FALSE)) +
  geom_point(aes(size = week), 
             alpha = .2)+
  geom_smooth(method = "lm", se = F) +
 # theme(legend.position = "none") +
  labs(x = "cw_area", 
       y = "Predawn MPa") +
  #color_very_many +
  theme(legend.position = "none")
```
Midday slopes for each individual: 

All dates: 

Include site?

```{r}
space_df_nosite <- wc_wk_centered_df %>% 
  drop_na(site)

space_mod <- lmer(cwc ~ cw_area + (1|week) + (cw_area|tree), data = space_df_nosite, REML = F)
#summary(space_mod)
AIC(space_mod)

space_mod_site <- lmer(cwc ~ cw_area  + (1|week) + (cw_area|tree) + (1|site), data = space_df_nosite,  REML = F)

AIC(space_mod_site)
#summary(space_mod_site)

anova(space_mod, space_mod_site)
```
NO

####All time
```{r}
wc_quag_md_df <- wc_quag_df %>% 
  filter(time == "md")

#with separate periods: 
time_season_mod <- lmer(cwc ~ cw_area + time_season + (1|week) + (cw_area|tree), data = wc_quag_md_df)

time_season_mod_df <- broom::tidy(time_season_mod)

#with separate periods: 
time_season_mod_int <- lmer(cwc ~ cw_area*time_season + (1|week) + (cw_area|tree), data = wc_quag_md_df)

time_season_mod_int_df <- broom::tidy(time_season_mod)

time_mod <- lmer(cwc ~ cw_area + (1|week) + (cw_area|tree), data = wc_quag_md_df)
#time_mod <- lmer(cwc ~ cw_area + (cw_area|tree), data = wc_quag_md_df)
 
MuMIn::r.squaredGLMM(time_mod)

summary(time_mod)

ran_list <- coef(time_mod)

tree_eff <- as.data.frame(ran_list[['tree']]) %>% 
  mutate(estimate = `(Intercept)`, 
         slope = cw_area
         ) %>%
  select(-`(Intercept)`, 
          -cw_area)
tree_eff

ran_err_tree1 <- arm::se.ranef(time_mod)

ran_err_tree2 <- as.data.frame(ran_err_tree1[['tree']]) %>% 
  mutate(std.error = `(Intercept)`, 
         std.error.slope = `cw_area`
         )%>% 
  select(-`(Intercept)`, 
        # -cw_area
         ) %>% 
  tibble::rownames_to_column("tree") # Apply rownames_to_column

ran_df_tree <- bind_cols(tree_eff, ran_err_tree2) %>% 
  #select(-`1:47`) %>% 
  data_frame()

ran_df_tree %>% 
  mutate(tree = as.factor(tree)) %>% 
  mutate(upr = estimate + (std.error), 
         lwr = estimate - (std.error)) %>% 
  ggplot(aes(color= tree)
    ) + 
  geom_point(aes(y = estimate ,x = tree), size =3) +
    geom_point(aes(y = upr, x = tree), size = 1) +
  geom_point(aes(y = lwr, x = tree), size = 1) +
  geom_segment(aes(y= lwr, 
                   yend = upr, 
                   x = tree, 
                   xend = tree, 
                   color = tree))+
  labs(x = "Tree", 
       color = "Tree", 
       y = "Slope (Midday MPa ~ cw_area)") +
theme(
  strip.background = element_blank(),
  strip.text.y = element_blank(), 
  strip.text.x = element_text(size = 18), 
 # axis.text.y = element_blank(), 
  #axis.ticks.y = element_blank(), 
  axis.title = element_text(size = 20), 
  legend.title = element_text(size = 18)
  ) +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))# +
  #color_very_many 

ran_df_tree %>% 
  ggplot(aes(x = slope))+
  #geom_histogram() +
  geom_density()

ran_df_tree %>% 
  mutate(tree = as.factor(tree)) %>% 
  mutate(upr = slope + (std.error), 
         lwr = slope - (std.error)) %>% 
  ggplot(aes(color= estimate)
    ) + 
  geom_point(aes(y = slope ,x = tree), size =3) +
    geom_point(aes(y = upr, x = tree), size = 1) +
  geom_point(aes(y = lwr, x = tree), size = 1) +
  geom_segment(aes(y= lwr, 
                   yend = upr, 
                   x = tree, 
                   xend = tree, 
                   color = estimate))+
  labs(x = "Tree", 
       color = "Tree", 
       y = "Slope (Midday MPa ~ cw_area)") +
theme(
  strip.background = element_blank(),
  strip.text.y = element_blank(), 
  strip.text.x = element_text(size = 18), 
 # axis.text.y = element_blank(), 
  #axis.ticks.y = element_blank(), 
  axis.title = element_text(size = 20), 
  legend.title = element_text(size = 18)
  ) +
  theme(legend.position = "none", 
        axis.text.x = element_blank())#+
  #theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
```

Cant do separate for before vs after due to sample sizes. 

##Slopes, bootstrapping - inds
 
```{r}
time_summary_bs_tree <- final_df_all_cw_area %>% 
   filter(!week %in% c(9)) %>% 
  filter(analysis == "time, ind. tree") %>% 
   mutate(week = as.factor(week)) %>% 
ggplot() + 
  geom_point(aes(y = slope, x = time_season), size =3) +
    geom_point(aes(y = upr, x = time_season), size = 1) +
  geom_point(aes(y = lwr, x = time_season), size = 1) +
  #geom_line(aes(group = tree, y = tree, x = upr)) +
  geom_segment(aes(y= lwr, 
                   yend = upr, 
                   x = time_season, 
                   xend = time_season)) +
  labs(y = "Bootstrapped slope and CI", 
       x = "Time")
time_summary_bs_tree


ggsave(here("figures", "quag figures", "cw_area", "time_summary_slopes_boot_tree"), time_summary_bs_tree, device = "jpg", width = 2.5, height = 3, dpi = 300)
```

#MODELS

```{r}
glance_df <- bind_rows(space_glance <- broom.mixed::glance(space_mod_site) 
                       %>% mutate(mod = "space"),
                       time_glance <- broom.mixed::glance(time_season_mod)
                       %>% mutate(mod = "time"),
                       time_glance <- broom.mixed::glance(time_season_mod_int)
                       %>% mutate(mod = "interaction"),
                       as_data_frame(r.squaredGLMM(space_mod)) 
                       %>% mutate(mod = "space"),
                       as_data_frame(r.squaredGLMM(time_season_mod)) 
                       %>% mutate(mod = "time"),
                       as_data_frame(r.squaredGLMM(time_season_mod_int)) 
                       %>% mutate(mod = "interaction")) %>% 
  group_by(mod) %>% 
  fill(c(R2m, R2c), .direction = "downup") %>% 
  distinct() %>% 
  drop_na(df.residual)
glance_df
```


```{r}

space_mod_df <- broom::tidy(space_mod_site)  
cw_area_mods <- bind_rows(space_mod_df <- space_mod_df %>% mutate(mod = "space"),
                      time_season_mod_df <- time_season_mod_df %>% mutate(mod= "time"),
  time_season_mod_df <- time_season_mod_int_df %>% mutate(mod= "interaction")) %>% 
  bind_rows(glance_df) %>% 
  mutate(var = "cw_area")

cw_area_mods


write_csv(cw_area_mods, here::here("processed-data", "model results", "cw_area_cwc_mods.csv"))
```

#----------
#FIGURES


#Slopes: 

####Space - SE

```{r}
space_slope_df <- final_df_space_se%>%  
  mutate(week = case_when(
        week %in% c(10) ~ "2022-03-08",
        week %in% c(10) ~  "2022-03-15", 
        week %in% c(12) ~  "2022-03-25",
        week %in% c(14) ~  "2022-04-04",
        week %in% c(15) ~  "2022-04-11",
        week %in% c(17) ~  "2022-04-25", 
        week %in% c(18) ~ "2022-05-04",
        week %in% c(19) ~  "2022-05-09",
        week %in% c(21) ~  "2022-05-23",
        week %in% c(29) ~  "2022-07-19",
        week %in% c(33) ~  "2022-08-18",
        week %in% c(37) ~  "2022-09-15")) %>% 
  mutate(week = format(as.Date(week), "%m-%d")) %>% 
  mutate(week = as.factor(week))

unique(space_slope_df$week)
```

```{r}
# Define the weeks to highlight
highlighted_weeks <- c("05-09")  # Example weeks

space_slope <- final_df_space_se %>%  
  mutate(week = case_when(
        week %in% c(10) ~ "2022-03-08",
        week %in% c(11) ~  "2022-03-15", 
        week %in% c(12) ~  "2022-03-25",
        week %in% c(14) ~  "2022-04-04",
        week %in% c(15) ~  "2022-04-11",
        week %in% c(17) ~  "2022-04-25", 
        week %in% c(18) ~  "2022-05-04",
        week %in% c(19) ~  "2022-05-09",
        week %in% c(21) ~  "2022-05-23",
        week %in% c(29) ~  "2022-07-19",
        week %in% c(33) ~  "2022-08-18",
        week %in% c(37) ~  "2022-09-15")) %>% 
  mutate(week = format(as.Date(week), "%m-%d")) %>% 
  mutate(week = as.factor(week)) %>% 
  mutate(upr = slope + 1.96 * std.error.slope, 
         lwr = slope - 1.96 * std.error.slope, 
         is_highlighted = ifelse(week %in% highlighted_weeks, TRUE, FALSE)) %>% 
 ggplot(aes(color = as.factor(week)))  + 
  geom_point(aes(y = slope, x = week, shape = is_highlighted), size = 3) +
  geom_point(aes(y = upr, x = week), size = 1) +
  geom_point(aes(y = lwr, x = week), size = 1) +
  geom_segment(aes(y = lwr, yend = upr, x = week, xend = week, color = week)) +
  scale_shape_manual(values = c(1, 16)) + # Filled (16) and unfilled (1) points
  labs(x = "Week", color = "Week", y = " ") +
  theme(legend.position = "none",
        strip.background = element_blank(),
        strip.text.x = element_text(size = 12),
        plot.title = element_text(size = 13),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 12),
        legend.key = element_blank(), 
        legend.text = element_text(size = 13), 
        legend.title = element_blank(),
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(-5, -8, -8, -8),
        plot.margin = unit(c(5.5, 5.5, 0, 5.5), units = "pt"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = .25)) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  scale_color_manual(values = c("9" ="#122241",
                                                     "03-08" = "#48578E", #week 10
                                                    "03-15" = "#48578E", #10
                                                    # "11" = "#122451", 
                                                     "03-23" = "#165E6F", #12
                                                     "03-25" = "#165E6F", #12
                                                     "03-30" = "#B6D0E2", #14
                                                     "04-04" = "#B6D0E2", #14
                                                     "04-06" = "#B6D0E2", #14
                                                     #"13" = "#B6D0E2", 
                                                     "04-13" = "#729684", 
                                                     "04-11" = "#729684", 
                                                    # "16" = "#8E9D68", 
                                                     "04-27" = "#8E9D30", #17
                                                     "04-25" = "#8E9D30", #17
                                                    # "18" = "#D7B110",
                                                     "05-09" = "#D9C000", #19
                                                    # "20" = "#F8A63A" ,
                                                    # "21" = "#F8A63A" ,
                                                     "05-23" = "#EC7E28", #21
                                                     "07-19" = "#CC5210", #29
                                                     "08-18"= "#E97B6E", #33
                                                    # "37" = "#b33b72",
                                                     "09-15" = "#CC5265" #37
                                                     #"39" = "#862d46" 
                                                    # "39" = "#C969A1"
                                                   #  "37" = "#b33b72",
                                                   #  "39" = "#893843"
                                                    )) +
  guides(color = guide_legend(nrow = 2)) 

space_slope
```


```{r, eval = F}
space_slope <- space_slope_df %>% 
 # filter(week %in% c(14, 17, 21, 29)) %>% 
 # filter(term == "cwc") %>% 
  mutate(upr = slope + 1.96*(std.error.slope), 
         lwr = slope - 1.96*(std.error.slope)) %>% 
 ggplot(aes(color= as.factor(week))
    )  + 
  #  geom_rect(aes(ymin = 701.6674, ymax = 1074.701, 
  #         xmin = -Inf, xmax = Inf), 
  #         fill = "#969696",
  #         alpha = .01, 
  #         color = NA) +
  # geom_hline(aes(yintercept = 880.5797), color = "#525252") +
  geom_point(aes(y = slope ,x = week), size =3) +
    geom_point(aes(y = upr, x = week), size = 1) +
  geom_point(aes(y = lwr, x = week), size = 1) +
  #geom_line(aes(group = week, y = week, x = upr)) +
  geom_segment(aes(y= lwr, 
                   yend = upr, 
                   x = week, 
                   xend = week, 
                   color = week))+
  labs(x = "Week", 
       color = "Week", 
       y = " ") +
  theme(legend.position="none",
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
      axis.title.y = element_blank(),
      axis.title.x = element_blank(),
     axis.text = element_text(size = 12),
     legend.key=element_blank(), 
     legend.text = element_text(size = 13), 
    # legend.title = element_text(size = 16),
    legend.title = element_blank(),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8),
    plot.margin = unit(c(5.5, 5.5, 0, 5.5), units = "pt"),
     axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=.25)
    ) +
  geom_hline(yintercept = 0, linetype="dotted") + 
  scale_color_manual(values = c("9" ="#122241",
                                                     "03-08" = "#48578E", #week 10
                                                    "03-15" = "#48578E", #10
                                                    # "11" = "#122451", 
                                                     "03-23" = "#165E6F", #12
                                                     "03-25" = "#165E6F", #12
                                                     "03-30" = "#B6D0E2", #14
                                                     "04-04" = "#B6D0E2", #14
                                                     "04-06" = "#B6D0E2", #14
                                                     #"13" = "#B6D0E2", 
                                                     "04-13" = "#729684", 
                                                     "04-11" = "#729684", 
                                                    # "16" = "#8E9D68", 
                                                     "04-27" = "#8E9D30", #17
                                                     "04-25" = "#8E9D30", #17
                                                       "05-04" = "#D7B110", #18
                                                     "05-09" = "#D9C000", #19
                                                    # "20" = "#F8A63A" ,
                                                    # "21" = "#F8A63A" ,
                                                     "05-23" = "#EC7E28", #21
                                                     "07-19" = "#CC5210", #29
                                                     "08-18"= "#E97B6E", #33
                                                    # "37" = "#b33b72",
                                                     "09-15" = "#CC5265" #37
                                                     #"39" = "#862d46" 
                                                    # "39" = "#C969A1"
                                                   #  "37" = "#b33b72",
                                                   #  "39" = "#893843"
                                                    )) +
  #scale_x_continuous(breaks = c(10, 12, 14,15, 17, 19, 21, 29, 33, 37)
                  #   breaks = c(37, 33, 29, 21, 19, 17, 15, 14, 12, 10)
                      # seq(10, 30, by = 1)
  #                   ) +
  geom_hline(yintercept = 0, linetype="dotted") + 
  guides(color = guide_legend(nrow = 2)) #+
space_slope
```

####Space - BS
```{r}
space_slope_bs <- final_df_all_cw_area %>% 
    # filter(!week %in% c(9)) %>% 
  mutate(week = case_when(
    week %in% c(10) ~ "2022-03-08",
    week %in% c(11) ~ "2022-03-15", 
    week %in% c(12) ~ "2022-03-25",
    week %in% c(14) ~ "2022-04-04",
    week %in% c(15) ~ "2022-04-11",
    week %in% c(17) ~ "2022-04-25", 
    week %in% c(19) ~ "2022-05-09",
    week %in% c(21) ~ "2022-05-23",
    week %in% c(29) ~ "2022-07-19",
    week %in% c(33) ~ "2022-08-18",
    week %in% c(37) ~ "2022-09-15")) %>%  
  filter(analysis == "space") %>% 
  mutate(week = format(as.Date(week), "%m-%d"),
         bounds_overlap_zero = (lwr <= 0 & upr >= 0)) %>%  # Check if bounds overlap 0
  filter(analysis == "space") %>% 
  ggplot(aes(color = as.factor(week))) + 
  geom_point(aes(y = slope, x = as.factor(week), shape = bounds_overlap_zero), size = 3) +  # Shape depends on overlap
  geom_point(aes(y = upr, x = as.factor(week)), size = 1) +
  geom_point(aes(y = lwr, x = as.factor(week)), size = 1) +
  geom_segment(aes(y = lwr, yend = upr, x = as.factor(week), xend = as.factor(week))) +
  labs(
    x = "Week", 
    color = "Week", 
    y = "Slope"
  ) +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    plot.title = element_text(size = 13),
    axis.title = element_blank(),
    axis.text = element_text(size = 12),
    legend.key = element_blank(), 
    legend.text = element_text(size = 13), 
    legend.title = element_blank(),
    legend.margin = margin(0, 0, 0, 0),
    legend.box.margin = margin(-5, -8, -8, -8),
    plot.margin = unit(c(5.5, 5.5, 0, 5.5), units = "pt"),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = .25)
  ) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  scale_color_manual(values = c(
    "03-08" = "#48578E", 
    "03-15" = "#48578E", 
    "03-25" = "#165E6F", 
    "04-04" = "#B6D0E2", 
    "04-11" = "#729684", 
    "04-25" = "#8E9D30", 
    "05-09" = "#D9C000", 
    "05-23" = "#EC7E28", 
    "07-19" = "#CC5210", 
    "08-18" = "#E97B6E", 
    "09-15" = "#CC5265"
  )) +
  scale_shape_manual(values = c(`TRUE` = 1, `FALSE` = 16))  # Open circle for TRUE, closed for FALSE

space_slope_bs
```

####Time

BS:

```{r}
time_summary <- final_df_all_cw_area%>% 
   filter(!week %in% c(9)) %>% 
  filter(analysis == "time, ind. tree") %>% 
   mutate(week = as.factor(week), 
          time_season = case_when(
            time_season %in% c("before leafout") ~ "During", 
             time_season %in% c("after leafout") ~ "After", 
            
          )) %>% 
ggplot(aes(color = time_season)) + 
  geom_point(aes(y = slope, x = time_season), size =3) +
  geom_point(aes(y = upr, x = time_season), size = 1) +
  geom_point(aes(y = lwr, x = time_season), size = 1) +
  geom_segment(aes(y= lwr, 
                   yend = upr, 
                   x = time_season, 
                   xend = time_season)) +
  labs(y = "",
       x = "Time") +
  color_two_grey +
  geom_hline(yintercept = 0, linetype="dotted") + 
  theme(legend.position="none",
       # legend.position= c(.7, .2),
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
     # axis.title = element_text(size = 16),
     axis.text.y = element_text(size = 12),
     axis.text.x = element_text(size = 12),
    # axis.text.x  = element_blank(),
     legend.key=element_blank(), 
      axis.title.x = element_blank(),
     axis.title.y = element_blank(),
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8),
    plot.margin = unit(c(5.5, 5.5, 0, 5.5), units = "pt")
    ) +
  scale_x_discrete(limit = rev)
  
time_summary
```





#*FIGURES*


#Scatterplots:

#####Space

```{r}
#scaled
space_nice_1 <- df %>% 
  filter(time == "md") %>% 
  select(tree, week, cwc, cw_area) %>% 
  distinct() %>% 
  drop_na(cw_area, cwc) %>% 
  ggplot(aes(y = cwc, 
            x = cw_area,
             color = as.factor(week)
             )) +
  geom_point(alpha = .5, 
            # aes (shape = site)
             ) +
  theme(legend.position="none",
       # legend.position= c(.7, .2),
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
     # axis.title = element_text(size = 16),
     axis.text.y = element_text(size = 12),
     axis.text.x = element_text(size = 12),
    # axis.text.x  = element_blank(),
     legend.key=element_blank(), 
      axis.title.x = element_blank(),
     axis.title.y = element_blank(),
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8),
    plot.margin = unit(c(5.5, 5.5, 0, 5.5), units = "pt")
    ) +
  geom_smooth(method = "lm", se = F,size = .5) + 
 # geom_vline(xintercept = 0, linetype = "dotted") +
  labs(#y= "Middays (MPa)", 
       y = " ",
       x = "Leaf Water per Area", 
       color = "Week", 
       shape = "Site") +
  #color_many_2 +
  color_week_assigned +
 # xlim(.5,2) +
 # ylim(-5,0)+
  guides(color = guide_legend(nrow = 2)) +
  #scale_x_reverse() +
scale_y_continuous(labels = scales::number_format(accuracy = 0.1))
space_nice_1


```
#####Time:

```{r}
time_1 <- df %>% 
  mutate(time = case_when(
    time == "md" ~ "Midday", 
    time == "pd" ~ "Predawn"
  )) %>% 
  filter(time == "Midday") %>% 
  drop_na(week) %>% 
 # filter(time == "md") %>% 
  ggplot(aes(y = cwc, 
             x = cw_area, 
             color = time_season, 
             size = week,
             shape = as.factor(tree),
             show.legend = FALSE)) +
  geom_point(size = 1,
             alpha = .1)+
  geom_smooth(method = "lm", se = F, size = .5, alpha = .4) +
 # theme(legend.position = "none") +
  labs(x = "cwc", 
       y = "Midday MPa") +
  #color_two_grey +
  theme(
      legend.position="none",
      strip.background = element_blank(),
     # strip.text.x = element_text(size = 12),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
      #axis.title = element_text(size = 15),
     axis.title = element_blank(),
     axis.text = element_text(size = 12),
     axis.text.x = element_text(size = 12),
     legend.key=element_blank(),
     legend.text = element_text(size = 13),
     legend.title = element_text(size = 16),
     #legend.title = element_blank(),
     legend.margin=margin(0,0,0,0),
      legend.box.margin=margin(-5,-8,-8,-8),
     plot.margin = unit(c(5.5, 5.5, 0, 5.5), units = "pt")
    ) +
  labs(#y= "Water Potential (MPa)", 
       y = "Water Potential (MPa)",
       x = "Leaf Water Content (g)", 
       color = "Week", 
       ) +
  guides(color = guide_legend(nrow = 2)) +
  color_two_grey +
scale_y_continuous(labels = scales::number_format(accuracy = 0.1))

time_1 
```

######Legend:

```{r}
legend_plot <- df  %>% 
  ungroup() %>% 
  add_row(date_wp = as.Date("2022-05-03"), time = "md", cw_area = .05, cwc = -.3) %>% 
  filter(date_wp %in% c("2022-03-08",
         "2022-03-15", 
         "2022-03-25",
         "2022-04-04",
         "2022-04-11",
         "2022-04-25", 
         #"2022-05-04",
         "2022-05-09",
         "2022-05-23",
         "2022-07-19",
         "2022-08-18",
         "2022-09-15")) %>%
  mutate(week = format(as.Date(date_wp), "%m-%d"))  %>% 
  drop_na(site) %>% 
  mutate(time = case_when(
    time == "md" ~ "Midday", 
    time == "pd" ~ "Predawn"
  )) %>% 
  filter(time == "Midday") %>% 
  filter(!(week == 9)) %>% 
  drop_na(week) %>% 
  ggplot(aes(y = cwc,
             x = cw_area,
             color = as.factor(week), 
            # shape = as.factor(time),
             )) +
  geom_point() +
  theme(legend.position="right",
       # legend.position= c(.7, .2),
      strip.background = element_blank(),
      strip.text.x = element_text(size = 12),
      plot.title = element_text(size=13),
     # axis.title = element_text(size = 16),
     axis.text = element_text(size = 12),
     legend.key=element_blank(), 
     axis.title.x = element_blank(),
     axis.title.y = element_blank(),
     legend.text = element_text(size = 13), 
     legend.title = element_text(size = 16),
     legend.margin=margin(0,.2,.2,.2),
   # legend.box.margin=margin(-5,-8,-8,-8)
    ) +
  geom_smooth(method = "lm", se = F, size = .5) + 
  labs(color = "Date", 
       shape = "Time") +
  scale_color_manual(values = c("9" ="#122241",
                                                     "03-08" = "#122241", #week 10
                                                   # "03-15" = "#48578E", #10
                                                    # "11" = "#122451", 
                                                     "03-23" = "#165E6F", #12
                                                     "03-25" = "#165E6F", #12
                                                     "03-30" = "#B6D0E2", #14
                                                     "04-04" = "#B6D0E2", #14
                                                     "04-06" = "#B6D0E2", #14
                                                     #"13" = "#B6D0E2", 
                                                     "04-13" = "#729684", 
                                                     "04-11" = "#729684", 
                                                    # "16" = "#8E9D68", 
                                                     "04-27" = "#8E9D30", #17
                                                     "04-25" = "#8E9D30", #17
                                                    "05-04" = "#D7B110", #18
                                                     "05-09" = "#D9C000", #19
                                                    # "20" = "#F8A63A" ,
                                                    # "21" = "#F8A63A" ,
                                                     "05-23" = "#EC7E28", #21
                                                     "07-19" = "#CC5210", #29
                                                     "08-18"= "#E97B6E", #33
                                                    # "37" = "#b33b72",
                                                     "09-15" = "#CC5265" #37
                                                     #"39" = "#862d46" 
                                                    # "39" = "#C969A1"
                                                   #  "37" = "#b33b72",
                                                   #  "39" = "#893843"
                                                    )) #+
 # ylim(0,2) +
  #guides(color = guide_legend(nrow = 1))
legend_plot

legend_scatterplots <- cowplot::get_legend(legend_plot)
legend_scatterplots
```

#COMBINE

```{r}
library(grid)
#labels of slopes: 
y.grob1 <- textGrob("Slope (\U0394 CWC / \U0394 CWarea)",
                   gp=gpar(fontface="bold", #col="blue", 
                           fontsize=15), rot=90)

x.grob1 <- textGrob("Time", 
                   gp=gpar(fontface="bold", #col="blue", 
                           fontsize=15))

combined_slopes_wide <- cowplot::plot_grid(time_summary, NULL, space_slope_bs, 
                                           # NULL, pv_slope,
                                   nrow = 1, 
                                  rel_widths = c(1, -.005, 1  #, -.02, .5
                                                 ), 
                                  labels = c("C", "", "D"#,"", "G"
                                             ),
                                  label_x = .1,
                                  hjust= c(-.75, 0, 0),
                                  label_y = .98
                                  # rel_heights = c(.15, 1, .3), 
                                   #rel_widths = c(1, 1, 1), 
                                  # rel_widths = c(.7, .8, .7, .3)
                                   ) 

combined_slopes_wide

combined_slopes_wide_labels <- grid.arrange(arrangeGrob(combined_slopes_wide, 
                            left = y.grob1, 
                            bottom = x.grob1),
                            heights = c(1, .05))

#labels of scatterplots: 
y.grob2 <- textGrob("CWC (g/cm2)", 
                   gp=gpar(fontface="bold", #col="blue", 
                           fontsize=15), rot=90)

x.grob2 <- textGrob("CWarea (g/cm2)", 
                   gp=gpar(fontface="bold", #col="blue",
                           fontsize=15))


combined_plots_wide_nolegend <- cowplot::plot_grid(
                                      time_1,
                                      NULL, 
                                      space_nice_1, 
                                   labels=c("A","", "B"),
                                   label_x = .1,
                                   label_y = .98,
                                   nrow = 1,
                                   rel_widths = c(1, -0, 1)
                                   #rel_widths = c(1, 1, 1)
                                   ) 
combined_plots_wide_nolegend

combined_plots_wide <- cowplot::plot_grid(combined_plots_wide_nolegend,
                                      legend_scatterplots,
                                          nrow = 1, 
                                          rel_heights = c(1, 1))

combined_plots_wide_labels <- grid.arrange(arrangeGrob(combined_plots_wide_nolegend,
                                left = y.grob2, 
                                bottom = x.grob2,
                               # right = legend_scatterplots,
                                heights = c(1, 0)))
combined_plots_wide_labels 

combined_plots_all <- cowplot::plot_grid(
  combined_plots_wide_labels, 
  combined_slopes_wide_labels, 
          nrow = 2, 
          rel_heights = c(.75, .6))

combined_plots_all

combined_plots_all_legend <- grid.arrange(arrangeGrob(combined_plots_all,
                                right = legend_scatterplots,
                                heights = c(1, 0), 
                                widths = c(1, .02)))
combined_plots_all_legend

ggsave(here("figures", "quag figures", "cw_area", "combined_plots_all_quag_cwc_bs"), combined_plots_all_legend, device = "jpg", width = 10, height = 7, dpi = 300)
```
